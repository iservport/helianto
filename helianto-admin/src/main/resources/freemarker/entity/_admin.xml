<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.springframework.org/schema/webflow
        http://www.springframework.org/schema/webflow/spring-webflow-2.0.xsd">
        
	<secured attributes="ROLE_ADMIN_MANAGER" />
   
	<persistence-context />

	<input name="userAssociation"/>
	
	<on-start>
	   <set name="flowScope.basePath" value="'entity/'"/>
	   <set name="flowScope.assign"   value="'assign'"/>
	   <set name="flowScope.parent"   value="userAssociation.parent"/>
	</on-start>

	<action-state id="preFilter">
		<evaluate expression="userAssociationAction.preFilter(flowScope, currentUser.principal)" />
		<transition on="success" to="filter" />
	</action-state>

	<action-state id="filter">
		<evaluate expression="userAssociationAction.filter(flowScope, currentUser.principal)" />
		<transition on="success" to="show.view" />
	</action-state>

   <view-state id="show.view" view="/frame2" model="userAssociationFilter">

      <on-render>
         <set name="viewScope.sidebar"  value="'entity_bar'"/>
         <set name="viewScope.siderel"  value="'entity_rel'"/>
         <set name="viewScope.template" value="'entity'"/>
         <set name="viewScope.userGroupList"       value="userAssociationFilter.parentList"/>
         <set name="viewScope.userAssociationList" value="userAssociationFilter.list"/>
      </on-render>

      <transition on="selectUserAssociation" to="userAssociation.subflow" />
      <transition on="createUserAssociation" to="userAssociation.subflow" />
      <transition on="selectUserGroup"       to="filter" />
      <transition on="toSelection"           to="toSelection"/>
      <transition on="toHome"                to="toHome"/>
      
   </view-state>

	<!-- 
	 ! userAssociation.subflow
	 !-->
   <subflow-state id="userAssociation.subflow" subflow="_userAssociation">
		<input name="userAssociation" value="userAssociationFilter.item"/>
		<input name="userGroup"       value="userAssociationFilter.parentItem"/>
      <transition on="toParent" to="selection.view"/>
   </subflow-state>

	<!--
	 ! End states 
	// -->
   <end-state id="toHome"/>
   <end-state id="toSelection"/>

</flow>