<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE flow PUBLIC "-//SPRING//DTD WEBFLOW 1.0//EN"  
    "http://www.springframework.org/dtd/spring-webflow-1.0.dtd">

<flow start-state="create">

	<var name="identityForm" class="org.helianto.web.view.IdentityForm"/>

    <action-state id="create">
    	<action bean="identityAction"/>
		<transition on="success" to="identity.principal.view"/>
    </action-state>

    <view-state id="identity.principal.view" view="identity/principal">
		<transition on="next" to="persistIdentity"/>
    </view-state>

    <action-state id="persistIdentity">
    	<entry-actions>
	    	<action bean="identityAction" method="bind"/>
    	</entry-actions>
    	<action bean="identityAction"/>
		<transition on="success" to="identity.details.view"/>
        <transition on-exception="org.springframework.dao.DataIntegrityViolationException" 
        	to="nonUnique"/>
    </action-state>
    
    <action-state id="nonUnique">
    	<action bean="identityAction"/>
		<transition on="error" to="identity.principal.view"/>
    </action-state>

    <view-state id="identity.details.view" view="identity/details">
		<transition on="previous" to="identity.details.view"/>
		<transition on="next" to="ifPersonal"/>
    </view-state>
    
    <decision-state id="ifPersonal">
    	<entry-actions>
	    	<action bean="identityAction" method="bind"/>
    	</entry-actions>
    	<if test="${flowScope.identityForm.credential.identity.identityType == 'P'}" 
    	    then="identity.personal.view" 
    	    else="ifNotAddressable" />
    </decision-state>

    <view-state id="identity.personal.view" view="identity/personal">
		<transition on="previous" to="identity.details.view"/>
		<transition on="next" to="ifNotAddressable"/>
    </view-state>
    
    <decision-state id="ifNotAddressable">
    	<if test="${flowScope.identityForm.credential.identity.identityType == 'N'}" 
    	    then="identity.password.view" 
    	    else="identity.credential.view" />
    </decision-state>

    <view-state id="identity.credential.view" view="identity/credential">
		<transition on="send" to="ifNewPassword"/>
		<transition on="next" to="identity.confirm.view"/>
		<transition on="previous" to="identity.details.view"/>
    </view-state>
    
    <decision-state id="ifNewPassword">
    	<entry-actions>
	    	<action bean="identityAction" method="bind"/>
    	</entry-actions>
    	<if test="${flowScope.identityForm.sendOption == 'N'}" 
    	    then="generatePassword" 
    	    else="send" />
    </decision-state>

    <action-state id="generatePassword">
    	<action bean="identityAction"/>
		<transition on="success" to="send"/>
		<transition on="error" to="identity.credential.view"/>
    </action-state>
    
    <action-state id="send">
    	<entry-actions>
	    	<action bean="identityAction" method="bind"/>
    	</entry-actions>
    	<action bean="identityAction"/>
		<transition on="success" to="identity.confirm.view"/>
		<transition on="error" to="identity.credential.view"/>
    </action-state>
    
    <view-state id="identity.password.view" view="identity/password">
		<transition on="next" to="verify"/>
    </view-state>
    
    <action-state id="verify">
    	<entry-actions>
	    	<action bean="identityAction" method="bind"/>
    	</entry-actions>
    	<action bean="identityAction"/>
		<transition on="success" to="identity.confirm.view"/>
		<transition on="error" to="ifNotAddressable"/>
    </action-state>
    
    <view-state id="identity.confirm.view" view="identity/confirm">
		<transition on="change" to="ifPersonal"/>
		<transition on="confirm" to="persistFinal"/>
    </view-state>
    
    <action-state id="persistFinal">
    	<entry-actions>
	    	<action bean="identityAction" method="bind"/>
    	</entry-actions>
    	<action bean="identityAction"/>
		<transition on="success" to="end"/>
        <transition on-exception="org.springframework.dao.DataIntegrityViolationException" 
        	to="nonUnique"/>
    </action-state>
    
    <end-state id="end">
    	<output-mapper>
   			<mapping source="flowScope.identityForm.credential.identity" target="identity"/>
    	</output-mapper>
    </end-state>
    
    <end-state id="abort" view="abort"/>
    
	<global-transitions>
        <transition on="error" to="error"/>
		<transition on="cancel" to="abort"/>
    </global-transitions>

</flow>