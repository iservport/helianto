<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
              http://www.springframework.org/schema/webflow
              http://www.springframework.org/schema/webflow/spring-webflow-1.0.xsd">

	<start-actions>
		<!-- create the backing form object and initialize a empty errors collection -->
		<action bean="identityAction" method="setupForm" />
	</start-actions>

	<start-state idref="createIfNecessary" />

    <action-state id="createIfNecessary">
    	<action bean="identityAction"/>
		<transition on="success" to="identity.principal.view"/>
    </action-state>

    <view-state id="identity.principal.view" view="identity/principal">
		<transition on="next" to="writeIdentity">
	    	<action bean="identityAction" method="bind"/>
		</transition>
    </view-state>

    <action-state id="writeIdentity">
    	<action bean="identityAction"/>
		<transition on="success" to="identity.details.view"/>
        <transition on-exception="org.springframework.dao.DataIntegrityViolationException" 
        	to="nonUnique"/>
    </action-state>
    
    <action-state id="nonUnique">
    	<action bean="identityAction"/>
		<transition on="error" to="identity.principal.view"/>
    </action-state>

    <view-state id="identity.details.view" view="identity/details">
		<transition on="previous" to="identity.principal.view"/>
		<transition on="next" to="ifPersonal">
	    	<action bean="identityAction" method="bind"/>
		</transition>
    </view-state>
    
    <decision-state id="ifPersonal">
    	<if test="${flowScope.identityForm.credential.identity.identityType == 'P'}" 
    	    then="identity.personal.view" 
    	    else="ifNotAddressable" />
    </decision-state>

    <view-state id="identity.personal.view" view="identity/personal">
		<transition on="previous" to="identity.details.view"/>
		<transition on="next" to="ifNotAddressable">
	    	<action bean="identityAction" method="bind"/>
		</transition>
    </view-state>
    
    <decision-state id="ifNotAddressable">
    	<if test="${flowScope.identityForm.credential.identity.identityType == 'N'}" 
    	    then="identity.password.view" 
    	    else="identity.credential.view" />
    </decision-state>

    <view-state id="identity.credential.view" view="identity/credential">
		<transition on="send" to="ifNewPassword"/>
		<transition on="next" to="identity.confirm.view">
	    	<action bean="identityAction" method="bind"/>
		</transition>
		<transition on="previous" to="identity.details.view"/>
    </view-state>
    
    <decision-state id="ifNewPassword">
    	<if test="${flowScope.identityForm.sendOption == 'N'}" 
    	    then="generatePassword" 
    	    else="send" />
    </decision-state>

    <action-state id="generatePassword">
    	<action bean="identityAction"/>
		<transition on="success" to="send"/>
		<transition on="error" to="identity.credential.view"/>
    </action-state>
    
    <action-state id="send">
    	<entry-actions>
	    	<action bean="identityAction" method="bind"/>
    	</entry-actions>
    	<action bean="identityAction"/>
		<transition on="success" to="identity.confirm.view"/>
		<transition on="error" to="identity.credential.view"/>
    </action-state>
    
    <view-state id="identity.password.view" view="identity/password">
		<transition on="next" to="verify">
	    	<action bean="identityAction" method="bind"/>
		</transition>
    </view-state>
    
    <action-state id="verify">
    	<action bean="identityAction"/>
		<transition on="success" to="identity.confirm.view"/>
		<transition on="error" to="ifNotAddressable"/>
    </action-state>
    
    <view-state id="identity.confirm.view" view="identity/confirm">
		<transition on="change" to="ifPersonal"/>
		<transition on="confirm" to="persistFinal">
	    	<action bean="identityAction" method="bind"/>
		</transition>
    </view-state>
    
    <action-state id="persistFinal">
    	<action bean="identityAction"/>
		<transition on="success" to="end"/>
        <transition on-exception="org.springframework.dao.DataIntegrityViolationException" 
        	to="nonUnique"/>
    </action-state>
    
    <end-state id="end">
    	<output-mapper>
			<output-attribute name="identityForm" scope="flow" />
    	</output-mapper>
    </end-state>
    
    <end-state id="abort" view="abort"/>
    
	<global-transitions>
        <transition on="error" to="error"/>
		<transition on="cancel" to="abort"/>
    </global-transitions>

</flow>