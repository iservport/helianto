<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE flow PUBLIC "-//SPRING//DTD WEBFLOW 1.0//EN"
	"http://www.springframework.org/dtd/spring-webflow-1.0.dtd">

<flow start-state="findDefaultEntity">

	<action-state id="findDefaultEntity">
        <action bean="simpleCoreMgr" 
            method="findDefaultEntity()"
            resultName="entity"
            resultScope="flow"/>
        <transition on="success" to="isEntityInScope"/>
        <transition on="error" to="abort.view"/>
    </action-state>
    
    <decision-state id="isEntityInScope">
    	<if test="${flowScope.entity!=null}" 
    	    then="createEmptyCredential" 
    	    else="abort.view"/>
    </decision-state>
	
	<action-state id="createEmptyCredential">
        <action bean="simpleCoreMgr" 
            method="createEmptyCredential()"
            resultName="credential"
            resultScope="flow"/>
        <transition on="success" to="register.view"/>
        <transition on="error" to="abort.view"/>
    </action-state>
	
    <view-state id="abort.view" view="abort">
		<transition on="finish" to="endUser"/>
    </view-state>

    <view-state id="register.view" view="register">
		<transition on="persistUser" to="bindCredential"/>
    </view-state>

	<action-state id="bindCredential">
        <action bean="credentialBinder" method="bindAndValidate()"/>
        <transition on="success" to="isPrincipalUnique"/>
        <transition on="error" to="register.view"/>
    </action-state>

    <decision-state id="isPrincipalUnique">
    	<action bean="simpleCoreMgr"
            method="isPrincipalUnique(${flowScope.entity.home}, ${flowScope.credential})"/>
        <transition on="yes" to="createSimpleUser"/>
        <transition on="no" to="endExistingUser"/>
    </decision-state>
    
	<action-state id="createSimpleUser">
        <action bean="simpleCoreMgr" 
            method="createUser(${flowScope.credential}, ${flowScope.entity})"
            resultName="user"
            resultScope="flow"/>
        <transition on="success" to="persistUser"/>
        <transition on="error" to="register.view"/>
    </action-state>
	
	<action-state id="persistUser">
        <action bean="simpleCoreMgr" 
            method="persistUser(${flowScope.user})"/>
        <transition on="success" to="welcome.view"/>
        <transition on="error" to="register.view"/>
    </action-state>
	
    <view-state id="welcome.view" view="welcome">
		<transition on="finish" to="endUser"/>
		<transition on="restart" to="createEmptyCredential"/>
    </view-state>
    
	<end-state id="endExistingUser" />
	
	<end-state id="endUser" />
	
</flow>

