<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
              http://www.springframework.org/schema/webflow
              http://www.springframework.org/schema/webflow/spring-webflow-1.0.xsd">

	<input-mapper>
		<input-attribute name="operator"  scope="flow" required="true"/>
		<input-attribute name="entity"    scope="flow" required="true"/>
		<input-attribute name="userGroup" scope="flow" required="true"/>
	</input-mapper>
	
	<start-actions>
		<set attribute="assign"    value="'user/assign'"      scope="flow"/>
	</start-actions>
	
	<start-state idref="isNew" />
	
	<decision-state id="isNew" >
		<if test="flowScope.userGroup.keyEmpty" 
		    then="userGroupEdit.view" 
		    else="userGroupBrowse.view"/>
	</decision-state>
	
	<!-- 001
	 ! userGroup
	 ! BROWSE VIEW
	 !-->
	<view-state id="userGroupBrowse.view" view="frame">
		<!-- 
		 ! before browse
		 -->
        <render-actions>
            <action bean="userGroupAction"       method="prepareTarget"/>
            <action bean="userGroupAction"       method="resolveAuthorization"/>
			<set attribute="sidenav"             value="'user/userGroup_nav'"  scope="flash"/>
			<set attribute="sidebar"             value="'user/userGroup_bar'"  scope="flash"/>
			<set attribute="template"            value="'user/userGroup'"      scope="flash"/>
        </render-actions>
		<!-- 
		 ! local transitions
		 -->
		<transition on="editTarget"              to="userGroupEdit.view"/>
		<transition on="editIdentity"            to="identityEdit.view"/>
		<transition on="createUserRole"          to="userRoleEdit.view">
			<action bean="userRoleAction"        method="createTarget"/>
		</transition>
		<transition on="editUserRole"            to="userRoleEdit.view">
			<action bean="userRoleAction"        method="selectTarget"/>
		</transition>
		<transition on="createUser"              to="userAssociation.subflow">
			<action bean="userAssociationAction" method="createTarget"/>
			<action bean="userAction"            method="createTarget"/>
		</transition>
		<transition on="selectUser"              to="user.subflow">
			<action bean="userAssociationAction" method="selectTarget"/>
		</transition>
		<!-- 
		 ! backward transitions
		 -->
		<transition on="toSelection"             to="toSelection"/>
	</view-state>
	
	<!-- 002
	 ! userGroup
	 ! EDIT VIEW
	 !-->
	<view-state id="userGroupEdit.view" view="frame">
		<!-- 
		 ! before browse
		 -->
        <render-actions>
            <action bean="userGroupAction" method="editTarget"/>
			<set attribute="sidenav"       value="'user/edit_nav'"       scope="flash"/>
			<set attribute="sidebar"       value="'user/userGroup_bar'"  scope="flash"/>
			<set attribute="template"      value="'user/userGroup_form'" scope="flash"/>
        </render-actions>
		<!-- 
		 ! local transitions
		 -->
		<transition on="storeTarget"       to="userGroupBrowse.view">
			<action bean="userGroupAction" method="bind" />
			<action bean="userGroupAction" method="storeTarget" />
		</transition>
	</view-state>

	<!-- 
	 ! identity  
	 ! EDIT VIEW
	 !-->
	<view-state id="identityEdit.view" view="frame">
		<!-- 
		 ! before browse
		 -->
        <render-actions>
            <action bean="userAction" method="editTarget"/>
			<set attribute="sidenav"   value="'user/edit_nav'"      scope="flash"/>
			<set attribute="sidebar"   value="'user/identity_bar'"  scope="flash"/>
			<set attribute="template"  value="'user/identity_form'" scope="flash"/>
        </render-actions>
		<!-- 
		 ! local transitions
		 -->
		<transition on="storeTarget"   to="storeIdentity">
			<action bean="userAction"            method="bind" />
		</transition>
	</view-state>
	<action-state id="storeIdentity">
		<action bean="userAction"                method="storeTarget"/>
		<transition on="success" to="userBrowse.view"/>
		<transition on="error"   to="identityEdit.view"/>
	</action-state>
	
	<!-- 
	 ! userRole  
	 ! EDIT VIEW
	 !-->
	<view-state id="userRoleEdit.view" view="frame">
		<!-- 
		 ! before browse
		 -->
        <render-actions>
            <action bean="userRoleAction" method="editTarget"/>
			<set attribute="sidenav"   value="'user/edit_nav'"      scope="flash"/>
			<set attribute="sidebar"   value="'user/identity_bar'"  scope="flash"/>
			<set attribute="template"  value="'user/userRole_form'" scope="flash"/>
        </render-actions>
		<!-- 
		 ! local transitions
		 -->
		<transition on="storeTarget"   to="storeUserRole">
			<action bean="userRoleAction"            method="bind" />
		</transition>
	</view-state>
	<action-state id="storeUserRole">
		<action bean="userRoleAction"                method="storeTarget"/>
		<transition on="success" to="userBrowse.view"/>
		<transition on="error"   to="userRoleEdit.view"/>
	</action-state>
	
	<!-- 
	 ! user
	 ! SUBFLOW
	 !-->
	<subflow-state id="user.subflow" flow="user">
		<attribute-mapper>
			<input-mapper>
				<mapping source="${flowScope.entity}"          target="entity"/>
				<mapping source="${flowScope.user}"            target="user"/>
			</input-mapper>
			<output-mapper>
				<output-attribute name="userGroup" scope="flow" />
			</output-mapper>
		</attribute-mapper>
		<transition on="toSelection" to="toSelection"/>
		<transition on="toHome"      to="toHome"/>
	</subflow-state>

	<!-- 
	 ! userAssociation
	 ! SUBFLOW
	 !-->
	<subflow-state id="userAssociation.subflow" flow="userAssociation">
		<attribute-mapper>
			<input-mapper>
				<mapping source="${flowScope.entity}"          target="entity"/>
				<mapping source="${flowScope.userAssociation}" target="userAssociation"/>
			</input-mapper>
			<output-mapper>
				<output-attribute name="userGroup" scope="flow" />
			</output-mapper>
		</attribute-mapper>
		<transition on="toSelection" to="userGroupBrowse.view"/>
		<transition on="toHome"      to="toHome"/>
	</subflow-state>

	<!--
	 ! End states 
	// -->

	<end-state id="toSelection" >
		<output-mapper>
			<mapping source="flowScope.entity" target="entity"/>
		</output-mapper>
	</end-state>
	<end-state id="toHome" />
	
	<!--
	 ! Globals 
	// -->

	<global-transitions>
		<transition on="toHome"       to="toHome"/>
		<transition on="cancelForm"   to="entityBrowse.view"/>
	</global-transitions>
	
</flow>
