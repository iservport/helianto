<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
              http://www.springframework.org/schema/webflow
              http://www.springframework.org/schema/webflow/spring-webflow-1.0.xsd">

	<start-state idref="preProcess" />
	
	<action-state id="preProcess">
		<action bean="operatorFilterAction" method="applyFilter"/>
		<transition to="entitySelection.view">
			<set attribute="assign"    value="'entity/assign'"      scope="flow"/>
		</transition>
	</action-state>
	
	<!-- 
	 ! entity 
	 ! SELECTION VIEW
	 !-->
	<view-state id="entitySelection.view" view="frame">
		<!-- 
		 ! before selection
		 -->
        <render-actions>
            <action bean="entityFilterAction" method="applyFilter"/>
			<set attribute="forward"   value="'entity/selection_fwd'"     scope="flash"/>
			<set attribute="sidenav"   value="'entity/selection_nav'"     scope="flash"/>
			<set attribute="sidebar"   value="'entity/selection_filter'"  scope="flash"/>
			<set attribute="headline"  value="'entity/headline'"          scope="flash"/>
			<set attribute="template"  value="'entity/selection'"         scope="flash"/>
			<set attribute="info"      value="'entity/info'"              scope="flash"/>
        </render-actions>
		<!-- 
		 ! forward transitions
		 -->
		<transition on="toProvince"  to="province.subflow"/>
		<transition on="toKeyType"  to="keyType.subflow"/>
		<transition on="toService"  to="service.subflow"/>
		<!-- 
		 ! local transitions
		 -->
		<transition on="selectTarget"  to="entityBrowse.view">
			<action bean="entityFilterAction"      method="selectTarget" />
		</transition>
		<transition on="createTarget"  to="entityEdit.view">
			<action bean="entityAction"            method="createTarget" />
		</transition>
	</view-state>

	<!-- 
	 ! entity  
	 ! BROWSE VIEW
	 !-->
	<view-state id="entityBrowse.view" view="frame">
		<!-- 
		 ! before browse
		 -->
        <render-actions>
            <action bean="entityAction"  method="prepareTarget"/>
            <action bean="entityAction"  method="resolveAuthorization"/>
			<set attribute="sidenav"     value="'entity/entity_nav'"  scope="flash"/>
			<set attribute="sidebar"     value="'entity/entity_bar'"  scope="flash"/>
			<set attribute="template"    value="'entity/entity'"      scope="flash"/>
        </render-actions>
		<!-- 
		 ! local transitions
		 -->
		<transition on="editTarget"        to="entityEdit.view"/>
		<transition on="createUser"        to="userEdit.view">
			<action bean="userAction"      method="createTarget"/>
		</transition>
		<transition on="createUserGroup"   to="userGroupEdit.view" >
			<action bean="userGroupAction" method="createTarget" />
		</transition>
		<transition on="selectUser"        to="userBrowse.view">
			<action bean="userAction"      method="selectTarget"/>
		</transition>
		<transition on="editUser"          to="userEdit.view">
			<action bean="userAction"      method="selectTarget"/>
		</transition>
		<!-- 
		 ! backward transitions
		 -->
		<transition on="toSelection"       to="entitySelection.view"/>
	</view-state>
	
	<!-- 
	 ! entity  
	 ! EDIT VIEW
	 !-->
	<view-state id="entityEdit.view" view="frame">
		<!-- 
		 ! before browse
		 -->
        <render-actions>
            <action bean="entityAction" method="editTarget"/>
			<set attribute="sidenav"   value="'entity/edit_nav'"    scope="flash"/>
			<set attribute="sidebar"   value="'entity/entity_bar'"  scope="flash"/>
			<set attribute="template"  value="'entity/entity_form'"      scope="flash"/>
        </render-actions>
		<!-- 
		 ! local transitions
		 -->
		<transition on="storeTarget"   to="entityBrowse.view">
			<action bean="entityAction"            method="bindAndValidate" />
			<action bean="entityAction"            method="storeTarget" />
		</transition>
	</view-state>
	<action-state id="storeEntity">
		<action bean="entityAction"                method="storeTarget"/>
		<transition on="success" to="entityBrowse.view"/>
		<transition on="error"   to="entityEdit.view"/>
	</action-state>
	
	<!-- 
	 ! province
	 ! SUBFLOW
	 !-->
	<subflow-state id="province.subflow" flow="province">
		<attribute-mapper>
			<input-mapper>
				<mapping source="flowScope.operator" target="operator"/>
			</input-mapper>
		</attribute-mapper>
		<transition on="toParent" to="entitySelection.view"/>
	</subflow-state>

	<!-- 
	 ! keyType
	 ! SUBFLOW
	 !-->
	<subflow-state id="keyType.subflow" flow="keyType">
		<attribute-mapper>
			<input-mapper>
				<mapping source="flowScope.operator" target="operator"/>
			</input-mapper>
		</attribute-mapper>
		<transition on="toParent" to="entitySelection.view"/>
	</subflow-state>

	<!-- 
	 ! service
	 ! SUBFLOW
	 !-->
	<subflow-state id="service.subflow" flow="service">
		<attribute-mapper>
			<input-mapper>
				<mapping source="flowScope.operator" target="operator"/>
			</input-mapper>
		</attribute-mapper>
		<transition on="toParent" to="entitySelection.view"/>
	</subflow-state>

	<!-- 
	 ! user
	 ! SUBFLOW
	 !-->
	<subflow-state id="user.subflow" flow="user">
		<attribute-mapper>
			<input-mapper>
				<mapping source="'returnOption'" target="filterOption"/>
			</input-mapper>
			<output-mapper>
				<output-attribute name="returnTarget" scope="request" />
			</output-mapper>
		</attribute-mapper>
		<transition on="returnTarget" to="storeUser">
			<action bean="userGroupAction" method="processReturnTarget"/>
		</transition>
		<transition on="toHome" to="toHome"/>
	</subflow-state>

	<!--
	 ! End states 
	// -->

	<end-state id="toHome" />
	
	<!--
	 ! Globals 
	// -->

	<global-transitions>
		<transition on="toHome"       to="toHome"/>
		<transition on="cancelForm"   to="entityBrowse.view"/>
	</global-transitions>
	
</flow>
